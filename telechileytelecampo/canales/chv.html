<!DOCTYPE html>
<html lang="es">
<head>
    <title>Reproductor de Video</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1">
    <style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #000;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
}

/* Contenedor principal centrado */
.video-container {
    position: relative;
    width: 100vw;
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #000;
}

/* Contenedor responsive del video */
.embed-responsive {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.embed-responsive-16by9 {
    position: relative;
    width: 100%;
    max-width: 100vw;
    max-height: 100vh;
    aspect-ratio: 16/9;
}

/* Contenedor del video centrado */
#video-player {
    position: absolute !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    width: 100% !important;
    height: 100% !important;
    object-fit: contain;
    max-width: 100vw;
    max-height: 100vh;
}

/* Asegurar que el iframe/video esté centrado */
#video-player iframe,
#video-player video {
    position: absolute !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    width: 100% !important;
    height: 100% !important;
    object-fit: contain !important;
}

/* Media queries para diferentes dispositivos */
@media (max-width: 768px) {
    .embed-responsive-16by9 {
        width: 100vw;
        height: 56.25vw; /* 16:9 aspect ratio */
        max-height: 100vh;
    }
    
    /* Si la altura calculada es mayor que la pantalla, usar toda la altura */
    @media (max-height: 56.25vw) {
        .embed-responsive-16by9 {
            width: 177.78vh; /* 16:9 aspect ratio inverso */
            height: 100vh;
            max-width: 100vw;
        }
    }
}

@media (max-width: 480px) {
    .embed-responsive-16by9 {
        width: 100vw;
        height: 56.25vw;
        max-height: 100vh;
    }
}

/* Landscape mode en móviles */
@media (max-height: 500px) and (orientation: landscape) {
    .embed-responsive-16by9 {
        width: 177.78vh;
        height: 100vh;
        max-width: 100vw;
    }
}

/* Tablets */
@media (min-width: 769px) and (max-width: 1024px) {
    .embed-responsive-16by9 {
        width: 100vw;
        height: 56.25vw;
        max-height: 100vh;
    }
    
    @media (max-height: 56.25vw) {
        .embed-responsive-16by9 {
            width: 177.78vh;
            height: 100vh;
            max-width: 100vw;
        }
    }
}

/* Desktop */
@media (min-width: 1025px) {
    .embed-responsive-16by9 {
        width: 100vw;
        height: 56.25vw;
        max-height: 100vh;
    }
    
    @media (max-height: 56.25vw) {
        .embed-responsive-16by9 {
            width: 177.78vh;
            height: 100vh;
            max-width: 100vw;
        }
    }
}

/* Muy alta resolución */
@media (min-width: 1920px) {
    .embed-responsive-16by9 {
        width: 100vw;
        height: 56.25vw;
        max-height: 100vh;
    }
    
    @media (max-height: 56.25vw) {
        .embed-responsive-16by9 {
            width: 177.78vh;
            height: 100vh;
            max-width: 100vw;
        }
    }
}
</style>
</head>
<body>
    <!-- Script del reproductor -->
    <script src='https://platform.s-mdstrm.com/js/player_api.js'></script>
    
    <div class="video-container">
        <div class="embed-responsive">
            <div class="embed-responsive-16by9">
                <div id="video-player"></div>
            </div>
        </div>
    </div>

    <script>
        'use strict';

        // Configuración del reproductor
        const VIDEO_CONFIG = {
            videoId: '63ee47e1daeeb80a30d98ef4',
            tokenUrl: 'https://chilevision.cl:8080/token.php/',
            playerSrc: 'ms_player_src_01',
            signal: 'live_1'
        };

        // Función para obtener el token y cargar el video
        async function loadVideo() {
            try {
                const now = Date.now();
                const tokenUrl = `${VIDEO_CONFIG.tokenUrl}${VIDEO_CONFIG.playerSrc}/${VIDEO_CONFIG.signal}/${VIDEO_CONFIG.videoId}/${now}.json`;
                
                const response = await fetch(tokenUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        msplayersrc: VIDEO_CONFIG.playerSrc,
                        senal: VIDEO_CONFIG.signal,
                        idsenal: VIDEO_CONFIG.videoId
                    })
                });

                const data = await response.json();
                const token = data.token;

                if (token) {
                    initializePlayer(token);
                } else {
                    console.error('No se pudo obtener el token');
                }
            } catch (error) {
                console.error('Error al cargar el video:', error);
            }
        }

        // Función para obtener dimensiones responsive centradas
        function getResponsiveDimensions() {
            const container = document.querySelector('.embed-responsive-16by9');
            const containerRect = container.getBoundingClientRect();
            
            return {
                width: Math.max(containerRect.width, 320),
                height: Math.max(containerRect.height, 180)
            };
        }

        // Función para inicializar el reproductor
        function initializePlayer(token) {
            const dimensions = getResponsiveDimensions();
            
            const playerOptions = {
                width: dimensions.width,
                height: dimensions.height,
                type: "live",
                protocol: "https",
                id: VIDEO_CONFIG.videoId,
                access_token: token,
                volumen: "100",
                autoplay: true,
                responsive: true,
                events: {
                    onPlayerReady: function() {
                        console.log("Reproductor listo");
                        // Asegurar centrado después de que el reproductor esté listo
                        centerVideo();
                    },
                    onPlay: function() {
                        console.log("Video iniciado");
                        centerVideo();
                    },
                    onVideoError: function() {
                        console.log("Error en el video");
                    },
                    onVolumeChange: function(volume) {
                        console.log("Volumen cambiado a: " + volume);
                    }
                }
            };

            // Crear el reproductor
            new MediastreamPlayer('video-player', playerOptions);
        }

        // Función para centrar el video
        function centerVideo() {
            setTimeout(() => {
                const player = document.querySelector('#video-player iframe, #video-player video');
                if (player) {
                    player.style.position = 'absolute';
                    player.style.top = '50%';
                    player.style.left = '50%';
                    player.style.transform = 'translate(-50%, -50%)';
                    player.style.width = '100%';
                    player.style.height = '100%';
                    player.style.objectFit = 'contain';
                }
            }, 100);
        }

        // Inicializar cuando la página esté lista
        document.addEventListener('DOMContentLoaded', function() {
            loadVideo();
        });

        // Auto-recarga cada 30 minutos para mantener la conexión
        setInterval(function() {
            loadVideo();
        }, 30 * 60 * 1000);

        // Manejar cambios de orientación y redimensionamiento
        window.addEventListener('resize', function() {
            // Debounce para evitar múltiples llamadas
            clearTimeout(window.resizeTimeout);
            window.resizeTimeout = setTimeout(function() {
                centerVideo();
            }, 250);
        });

        // Manejar cambios de orientación en móviles
        window.addEventListener('orientationchange', function() {
            setTimeout(function() {
                centerVideo();
            }, 500);
        });

        // Observer para asegurar que el video permanezca centrado
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList') {
                    const addedNodes = Array.from(mutation.addedNodes);
                    addedNodes.forEach(node => {
                        if (node.tagName === 'IFRAME' || node.tagName === 'VIDEO') {
                            centerVideo();
                        }
                    });
                }
            });
        });

        // Observar cambios en el contenedor del reproductor
        document.addEventListener('DOMContentLoaded', function() {
            const videoContainer = document.getElementById('video-player');
            if (videoContainer) {
                observer.observe(videoContainer, {
                    childList: true,
                    subtree: true
                });
            }
        });
    </script>
</body>
</html>
