<!DOCTYPE html>
<html lang="es">
<head>
    <title>Reproductor de Video</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1">
    <style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #000;
    overflow-x: hidden;
}

/* Contenedor principal responsive */
.video-container {
    position: relative;
    width: 100%;
    height: 100vh;
    min-height: 300px;
    background-color: #000;
}

/* Contenedor responsive del video */
.embed-responsive {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
}

.embed-responsive-16by9 {
    padding-bottom: 56.25%;
    height: 0;
}

/* Contenedor del video */
#video-player {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    object-fit: cover;
}

/* Media queries para diferentes dispositivos */
@media (max-width: 768px) {
    .video-container {
        height: 100vh;
        min-height: 250px;
    }
    
    /* Ajustar para pantallas muy pequeñas */
    .embed-responsive-16by9 {
        padding-bottom: 75%; /* Más cuadrado en móviles */
    }
}

@media (max-width: 480px) {
}

/* Landscape mode en móviles */
@media (max-height: 500px) and (orientation: landscape) {
    .video-container {
        height: 100vh;
    }
    
    .embed-responsive-16by9 {
        padding-bottom: 56.25%;
    }
}

/* Tablets */
@media (min-width: 769px) and (max-width: 1024px) {
    .video-container {
        height: 100vh;
        min-height: 400px;
    }
}

/* Desktop */
@media (min-width: 1025px) {
    .video-container {
        height: 100vh;
        min-height: 500px;
    }
}

/* Muy alta resolución */
@media (min-width: 1920px) {
}
</style>
</head>
<body>
    <!-- Script del reproductor -->
    <script src='https://platform.s-mdstrm.com/js/player_api.js'></script>
    
    <div class="video-container">
        <div class="embed-responsive embed-responsive-16by9">
            <div id="video-player"></div>
        </div>
    </div>

    <script>
        'use strict';

        // Configuración del reproductor
        const VIDEO_CONFIG = {
            videoId: '63ee47e1daeeb80a30d98ef4',
            tokenUrl: 'https://chilevision.cl:8080/token.php/',
            playerSrc: 'ms_player_src_01',
            signal: 'live_1'
        };

        // Función para obtener el token y cargar el video
        async function loadVideo() {
            try {
                const now = Date.now();
                const tokenUrl = `${VIDEO_CONFIG.tokenUrl}${VIDEO_CONFIG.playerSrc}/${VIDEO_CONFIG.signal}/${VIDEO_CONFIG.videoId}/${now}.json`;
                
                const response = await fetch(tokenUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        msplayersrc: VIDEO_CONFIG.playerSrc,
                        senal: VIDEO_CONFIG.signal,
                        idsenal: VIDEO_CONFIG.videoId
                    })
                });

                const data = await response.json();
                const token = data.token;

                if (token) {
                    initializePlayer(token);
                } else {
                    console.error('No se pudo obtener el token');
                }
            } catch (error) {
                console.error('Error al cargar el video:', error);
            }
        }

        // Función para obtener dimensiones responsive
        function getResponsiveDimensions() {
            const container = document.getElementById('video-player');
            const containerRect = container.getBoundingClientRect();
            
            return {
                width: Math.max(containerRect.width, 320),
                height: Math.max(containerRect.height, 180)
            };
        }

        // Función para inicializar el reproductor (replace the existing initializePlayer function)
        function initializePlayer(token) {
            const dimensions = getResponsiveDimensions();
            
            const playerOptions = {
                width: dimensions.width,
                height: dimensions.height,
                type: "live",
                protocol: "https",
                id: VIDEO_CONFIG.videoId,
                access_token: token,
                volumen: "100",
                autoplay: true,
                responsive: true,
                events: {
                    onPlayerReady: function() {
                        console.log("Reproductor listo");
                    },
                    onPlay: function() {
                        console.log("Video iniciado");
                    },
                    onVideoError: function() {
                        console.log("Error en el video");
                    },
                    onVolumeChange: function(volume) {
                        console.log("Volumen cambiado a: " + volume);
                    }
                }
            };

            // Crear el reproductor
            new MediastreamPlayer('video-player', playerOptions);
        }

        // Inicializar cuando la página esté lista
        document.addEventListener('DOMContentLoaded', function() {
            loadVideo();
        });

        // Auto-recarga cada 30 minutos para mantener la conexión
        setInterval(function() {
            loadVideo();
        }, 30 * 60 * 1000);

        // Manejar cambios de orientación y redimensionamiento
        window.addEventListener('resize', function() {
            // Debounce para evitar múltiples llamadas
            clearTimeout(window.resizeTimeout);
            window.resizeTimeout = setTimeout(function() {
                // Recargar el reproductor con nuevas dimensiones si es necesario
                const player = document.querySelector('#video-player iframe, #video-player video');
                if (player) {
                    const dimensions = getResponsiveDimensions();
                    player.style.width = '100%';
                    player.style.height = '100%';
                }
            }, 250);
        });

        // Manejar cambios de orientación en móviles
        window.addEventListener('orientationchange', function() {
            setTimeout(function() {
                const dimensions = getResponsiveDimensions();
                const player = document.querySelector('#video-player iframe, #video-player video');
                if (player) {
                    player.style.width = '100%';
                    player.style.height = '100%';
                }
            }, 500);
        });
    </script>
</body>
</html>
